"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/auth.js"),a=require("../../utils/api.js");if(require("../../utils/request.js"),require("../../utils/env.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-popup-dialog"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+o+n+s+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+i+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js"))();const o=()=>"../components/abMiniButton.js",n=()=>"../components/abEmpty.js",s=()=>"./addRecords.js",i=()=>"../components/abRadio.js",u={__name:"orderBottom",props:{list:{type:Array,default:()=>[]},isChange:{type:Boolean,default:!1},queryData:{type:Object,default:()=>{}},allList:{type:Array,default:()=>[]},backupData:{type:Array,default:()=>[]}},emits:["clear","updateClone","initOrder","setCloneData"],setup(o,{emit:n}){const s=o,i=e.inject("btnStutas"),u=e.inject("socket"),r=e.computed((()=>{let e=s.list.reduce(((e,t)=>e+t.price*t.count),0);return parseFloat(e.toFixed(2))})),l=e.computed((()=>s.list.reduce(((e,t)=>e+t.count),0))),d=async()=>{if(s.isChange){if(s.queryData.id){let e=[];s.list.forEach((t=>{const a=s.backupData.find((e=>e.id==t.id));if(t.count!=a.count){let o=JSON.parse(JSON.stringify(t));o.count=t.count-a.count,o.count>0&&e.push(o)}})),await a.orderUpdateApi({id:s.queryData.id,orderDetail:s.list,totalMoney:r.value,totalCount:l.value,recordsList:e.length?e:"",isAdmin:!0}),n("setCloneData")}else{let o=e.dayjs().format("HH:mm"),n=await a.orderAddApi({orderName:o+"-"+s.queryData.desk+"号桌",isPack:!1,taste:Number(v.value),isFinish:!1,totalCount:l.value,totalMoney:r.value,orderDetail:s.list.filter((e=>e.count>0)),actualMoney:0,desk:Number(s.queryData.desk)||"",userOperation:!0,isRead:!1},!0);console.log(n),t.getToken()||(i.value=!0,u.emit("message",{desk:s.queryData.desk,type:"submitted",orderId:n.data})),s.queryData.id=n.data,n.orderFlag&&(e.index.setStorageSync("orderId",n.data),e.index.reLaunch({url:"/pages/orderDetail/orderInfo"})),f.value.close()}n("updateClone"),e.index.showToast({icon:"success",title:"已提交"})}else e.index.showToast({title:"没有更改，无需提交",icon:"none"})},c=e.ref(null),p=e.ref([]),y=async()=>{let e=await a.addRecordsApi({orderId:s.queryData.id||"234wert"});p.value=e,c.value.open()};e.onBackPress((()=>{s.isChange&&e.index.showModal({title:"提示",content:"订单未保存，是否保存",success:async({confirm:e,cancel:t})=>!e||(await d(),!0)})}));const m=()=>{e.index.showModal({title:"提示",content:"确定要清空所有选项吗",showCancel:!0,success:({confirm:t,cancel:a})=>{t&&(n("clear"),e.index.showToast({icon:"success"}))}})},f=e.ref(null),v=e.ref("1"),h=async()=>{d()};let k=[];const w=e.ref(!1),D=()=>{e.index.showToast({title:"已重置菜单，请选择您要添加的菜品",icon:"none",mask:!1}),k=JSON.parse(JSON.stringify(s.allList)),i.value=!1,w.value=!0,n("clear")},q=async()=>{let o=s.list.filter((e=>e.count>0));await a.addFoodsApi({orderId:s.queryData.id,desk:s.queryData.desk,items:o,totalMoney:r.value,totalCount:l.value});let d="";o.forEach((e=>{d+=` ${e.name}  x ${e.count} \n`})),t.getToken()||u.emit("message",{msg:d,desk:s.queryData.desk,type:"addFoods",orderId:s.queryData.id}),e.index.showModal({title:"提示",content:"提交成功，等待上菜吧",confirmText:"知道了",showCancel:!1}),i.value=!0,w.value=!1,n("initOrder")},g=()=>{e.index.showModal({title:"提示",content:"是否放弃本次加菜",showCancel:!0,success:({confirm:e,cancel:t})=>{e&&(i.value=!0,w.value=!1,n("updateClone",k))}})},x=e.ref(1),b=async()=>{e.index.showModal({title:"设置桌号",content:x.value,editable:!0,placeholderText:"请输入桌号",showCancel:!0,success:async({confirm:t,cancel:o,content:n})=>{t&&(await a.orderUpdateApi({id:s.queryData.id,desk:Number(n)}),e.index.showToast({title:"成功",icon:"success",mask:!0}))}})};return u.on("message",(a=>{if(s.queryData.desk&&s.queryData.desk==a.desk){if("submitted"==a.type)return void e.index.showModal({title:"提示",content:"您的同桌已经提交了订单",showCancel:!1,confirmText:"知道了",success:()=>{n("initOrder")}});t.getToken()||e.index.showModal({title:"来自您同桌的加菜",content:a.msg,showCancel:!1,confirmText:"知道了",success:()=>{n("initOrder")}})}})),(a,n)=>e.e({a:e.p({type:"cart",color:"",size:"24"}),b:e.t(e.unref(r).toFixed(2)),c:e.o(m),d:e.p({type:"warn",icon:"close"}),e:e.unref(t.getToken)()},e.unref(t.getToken)()?{f:e.o(b)}:{},{g:e.o(y),h:o.queryData.desk&&e.unref(i)},o.queryData.desk&&e.unref(i)?{i:e.o(D)}:{},{j:!e.unref(i)&&w.value},!e.unref(i)&&w.value?{k:e.o(g)}:{},{l:!e.unref(i)&&w.value&&!o.list.every((e=>0==e.count))},e.unref(i)||!w.value||o.list.every((e=>0==e.count))?{}:{m:e.o(q),n:e.p({type:"warn",icon:"plusempty"})},{o:o.queryData.id&&!o.queryData.desk},o.queryData.id&&!o.queryData.desk?{p:e.o(d),q:e.p({type:"warn"})}:{},{r:!o.queryData.id},o.queryData.id?{}:{s:e.o((e=>f.value.open())),t:e.p({type:"warn"})},{v:e.o((e=>c.value.close())),w:e.p({type:"closeempty",color:"#ccc",size:"24"}),x:o.list.length},o.list.length?{y:e.f(o.list,((t,a,o)=>({a:e.t(t.name),b:e.t(t.price.toFixed(2)),c:e.t(t.count),d:e.t((t.price*t.count).toFixed(2)),e:t.id}))),z:e.t(e.unref(l)),A:e.t(e.unref(r))}:{B:e.p({text:"暂无数据"})},{C:p.value.length>1},p.value.length>1?{D:e.p({recordsList:p.value})}:{},{E:e.sr(c,"bd3b83a2-9",{k:"popupOne"}),F:e.p({type:"bottom"}),G:e.o((e=>v.value=e)),H:e.p({list:[{label:"正常辣",value:"1"},{label:"微辣",value:"2"},{label:"特辣",value:"3"}],modelValue:v.value}),I:e.o((e=>f.value.close())),J:e.o(h),K:e.p({title:"添加订单",duration:2e3,"before-close":!0}),L:e.sr(f,"bd3b83a2-13",{k:"popupTwo"}),M:e.p({type:"dialog"})})}};wx.createComponent(u);
